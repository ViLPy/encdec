<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Playground</title>
  <style>
    .label > * {
      display: block;
    }

    .output-section {
      margin: 16px 0;
    }

    .output {
      display: inline-block;
      border: 1px solid #808080;
      min-height: 30px;
      min-width: 200px;
      margin: 0;
    }

    .output--encrypt {
      word-break: break-all;
      white-space: pre-wrap;
    }

    .output--decrypt {
      word-break: break-word;
      white-space: pre-wrap;
    }

    .output--error {
      border: 1px solid #f00000;
      color: #f00000;
      font-weight: 600;
    }
  </style>
</head>
<body>
<section class="playground">
  <label class="label">
    Key phrase:
    <input type="password" id="keyphrase">
  </label>

  <label class="label">
    Password:
    <input type="password" id="password">
  </label>

  <div class="message">
    <label class="label">
      Enter a message:
      <textarea id="message-input" rows="20" cols="80"></textarea>
    </label>
  </div>

  <section class="output-section">
    <div>Output</div>
    <pre id="output" class="output"></pre>
  </section>

  <input type="button" id="encrypt" value="Encrypt">
  <input type="button" id="decrypt" value="Decrypt">
  <input type="button" id="copy" value="Copy">
</section>

<script type="text/javascript">
  function pack(buffer) {
    return window.btoa(
      String.fromCharCode.apply(null, new Uint8Array(buffer))
    );
  }

  function unpack(packed) {
    const string = window.atob(packed);
    const buffer = new ArrayBuffer(string.length);
    const bufferView = new Uint8Array(buffer);

    for (let i = 0; i < string.length; i++) {
      bufferView[i] = string.charCodeAt(i);
    }

    return buffer
  }

  function encodeString(input) {
    const encoder = new TextEncoder();
    return encoder.encode(input);
  }

  function decodeString(input) {
    const decoder = new TextDecoder();
    return decoder.decode(input);
  }

  function getSetup() {
    const keyphrase = document.getElementById('keyphrase').value;

    return {
      salt: encodeString(keyphrase.substr(0, Math.floor(keyphrase.length / 2))),
      iv: encodeString(keyphrase.substr(Math.floor(keyphrase.length / 2)))
    }
  }

  function getInputMessage() {
    return document.getElementById('message-input').value;
  }

  function getKeyMaterial() {
    let password = document.getElementById('password').value;
    let enc = new TextEncoder();
    return window.crypto.subtle.importKey(
      'raw',
      enc.encode(password),
      { name: 'PBKDF2' },
      false,
      ['deriveBits', 'deriveKey']
    );
  }

  function getKey(keyMaterial, salt) {
    return window.crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt: salt,
        iterations: 500000,
        hash: 'SHA-256'
      },
      keyMaterial,
      { 'name': 'AES-GCM', 'length': 256 },
      true,
      ['encrypt', 'decrypt']
    );
  }

  function resetOutput() {
    const outputElement = document.getElementById('output');

    outputElement.textContent = '';
    outputElement.classList.remove('output--encrypt');
    outputElement.classList.remove('output--decrypt');
    outputElement.classList.remove('output--error');
  }

  async function encrypt() {
    const { iv, salt } = getSetup();
    const keyMaterial = await getKeyMaterial();

    const key = await getKey(keyMaterial, salt);
    const encoded = encodeString(getInputMessage());

    const ciphertext = await window.crypto.subtle.encrypt(
      {
        name: 'AES-GCM',
        iv: iv
      },
      key,
      encoded
    );

    const outputElement = document.getElementById('output');
    outputElement.textContent = pack(ciphertext);
    outputElement.classList.add('output--encrypt');
  }


  async function decrypt() {
    resetOutput();
    const outputElement = document.getElementById('output');

    const { iv, salt } = getSetup();
    let keyMaterial = await getKeyMaterial();
    let key = await getKey(keyMaterial, salt);

    try {
      let decrypted = await window.crypto.subtle.decrypt(
        {
          name: 'AES-GCM',
          iv: iv
        },
        key,
        unpack(getInputMessage())
      );

      outputElement.textContent = decodeString(decrypted);
      outputElement.classList.add('output--decrypt');
    } catch (e) {
      outputElement.classList.add('output--error');
      outputElement.textContent = '*** Decryption error ***';
    }
  }

  function copy() {
    const outputElement = document.getElementById('output');
    navigator.clipboard.writeText(outputElement.textContent);
  }

  const encryptButton = document.getElementById('encrypt');
  encryptButton.addEventListener('click', encrypt);

  const decryptButton = document.getElementById('decrypt');
  decryptButton.addEventListener('click', decrypt);

  const copyButton = document.getElementById('copy');
  copyButton.addEventListener('click', copy);
</script>
</body>
</html>
